<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuizBux - Earn Money</title>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loadingScreen">
    <h2>Loading QuizBux...</h2>
    <p>Please wait</p>
  </div>

  <!-- Main App -->
  <div id="app">

    <!-- Header -->
    <header id="header">
      <img id="logo-img" src="" alt="Logo">
      <div class="header-buttons">
        <button onclick="toggleChat()">ðŸ’¬ Chat</button>
        <button onclick="showAlert('Support: contact@quizbux.com')">Help</button>
        <button onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Auth Screens -->
    <section id="authScreens">
      <div class="auth-container">
        <!-- Login Card -->
        <div id="loginCard" class="auth-card">
          <h1>Welcome Back</h1>
          <p>Sign in to start earning</p>
          <input type="text" id="loginUsername" class="auth-input" placeholder="Username">
          <input type="password" id="loginPassword" class="auth-input" placeholder="Password">
          <button class="auth-btn" onclick="login()">Login</button>
          <div class="auth-switch">
            Don't have an account? <a onclick="showSignup()">Sign up</a>
          </div>
        </div>

        <!-- Signup Card -->
        <div id="signupCard" class="auth-card">
          <h1>Create Account</h1>
          <p>Join now to start earning</p>
          <input type="text" id="signupUsername" class="auth-input" placeholder="Choose Username">
          <input type="email" id="signupEmail" class="auth-input" placeholder="Email Address">
          <input type="password" id="signupPassword" class="auth-input" placeholder="Create Password">
          <button class="auth-btn" onclick="signup()">Create Account</button>
          <div class="auth-switch">
            Already have an account? <a onclick="showLogin()">Login</a>
          </div>
        </div>

        <!-- Verification Card -->
        <div id="verifyCard" class="auth-card">
          <h1>Verify Email</h1>
          <p>We sent a 6-digit code to your email</p>
          <div class="verification-code">
            <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)">
            <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)">
            <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)">
            <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 4)">
            <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 5)">
            <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 6)">
          </div>
          <button class="auth-btn" onclick="verifyEmail()">Verify Code</button>
          <div class="auth-switch">
            Didn't receive code? <a onclick="resendCode()">Resend</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard">
      <div class="profile">
        <div class="avatar" id="userAvatar">U</div>
        <div>
          <h2 id="displayUsername">User <span id="userStatus" class="user-status status-active">Active</span></h2>
          <div>
            <strong id="balanceValue">0</strong> Points â€¢ 
            <strong id="usdBalanceValue">$0.0000</strong>
          </div>
        </div>
      </div>

      <nav class="nav">
        <button onclick="showPage('work')">Work</button>
        <button onclick="showPage('offerwalls')">Offerwalls</button>
        <button onclick="showPage('cashout')">Cashout</button>
        <button onclick="showPage('terms')">Terms</button>
      </nav>

      <div id="pages">
        <!-- Work Page -->
        <div id="work" class="page">
          <h3>Submit Your Work</h3>
          <textarea id="workInput" class="auth-input" placeholder="Describe what you did today... (e.g. completed surveys, watched videos, etc.)"></textarea>
          <button class="auth-btn" onclick="submitWork()">Submit Work</button>
          <p>
            Approved work = 50 Points + $0.001 USD
          </p>
        </div>

        <!-- Offerwalls Page -->
        <div id="offerwalls" class="page">
          <h3>Earn More with Offerwalls</h3>
          <div id="offerwallList">
            <p>Loading offerwalls...</p>
          </div>
          <div id="iframeContainer" class="iframe-container">
            <button class="close-iframe" onclick="closeIframe()">Ã—</button>
            <iframe id="offerwallFrame" class="offerwall-iframe" src="about:blank"></iframe>
          </div>
        </div>

        <!-- Cashout Page -->
        <div id="cashout" class="page">
          <h3>Request Cashout</h3>
          <select id="rewardSelect" class="auth-input">
            <option value="">Choose reward...</option>
          </select>
          <button id="cashoutBtn" class="auth-btn" onclick="submitCashout()">Request Cashout</button>
          <p>
            1 USD = 50,000 Points<br>
            You need both Points & USD balance
          </p>

          <!-- Cashout History -->
          <div class="cashout-history">
            <h4>Cashout History</h4>
            <div id="cashoutHistory">
              <p>Loading history...</p>
            </div>
          </div>
        </div>

        <!-- Terms Page -->
        <div id="terms" class="page">
          <div id="termsContent"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Chat System -->
  <button id="chatToggle">ðŸ’¬</button>
  <div id="chatBox">
    <div class="chat-header">
      <span>Support Chat</span>
      <button class="chat-close" onclick="toggleChat()">Ã—</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message other">
        <div class="message-sender">Support</div>
        Welcome to QuizBux! How can we help you?
      </div>
    </div>
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="handleChatInput(event)">
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alertModal">
    <div class="modal">
      <p id="alertMessage">Message</p>
      <button onclick="closeAlert()">OK</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyEp9gDxpguJpVVaRAXzHCkOOwu40rH3gRhAet39nbLEXiprHzYzUcPseXUZD2aHGPscw/exec";

    let currentUser = null;
    let pendingUser = null;
    let chatInterval = null;

    function init() {
      console.log('ðŸš€ Initializing QuizBux...');
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      showLogin();
    }

    function showLogin() {
      hideAllAuthCards();
      document.getElementById('loginCard').style.display = 'block';
    }

    function showSignup() {
      hideAllAuthCards();
      document.getElementById('signupCard').style.display = 'block';
    }

    function showVerification() {
      hideAllAuthCards();
      document.getElementById('verifyCard').style.display = 'block';
    }

    function hideAllAuthCards() {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('signupCard').style.display = 'none';
      document.getElementById('verifyCard').style.display = 'none';
    }

    function moveToNext(input, nextIndex) {
      if (input.value.length === 1) {
        const nextInput = document.querySelectorAll('.code-input')[nextIndex];
        if (nextInput) nextInput.focus();
      }
    }

    async function signup() {
      const username = document.getElementById('signupUsername').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;

      if (!username || !email || !password) {
        return showAlert('Please fill all fields');
      }

      const formData = new FormData();
      formData.append('action', 'signup');
      formData.append('username', username);
      formData.append('email', email);
      formData.append('password', password);

      try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const data = await response.json();

        if (data.status === 'success') {
          pendingUser = { username, email, password };
          showVerification();
          showAlert('Verification code sent to your email!');
        } else {
          showAlert(data.message || 'Signup failed');
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
      }
    }

    async function verifyEmail() {
      const codeInputs = document.querySelectorAll('.code-input');
      const code = Array.from(codeInputs).map(input => input.value).join('');

      if (code.length !== 6) {
        return showAlert('Please enter the 6-digit code');
      }

      const formData = new FormData();
      formData.append('action', 'verifyEmail');
      formData.append('username', pendingUser.username);
      formData.append('email', pendingUser.email);
      formData.append('password', pendingUser.password);
      formData.append('code', code);

      try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const data = await response.json();

        if (data.status === 'success') {
          showAlert('Account verified successfully! You can now login.');
          showLogin();
          pendingUser = null;
        } else {
          showAlert(data.message || 'Verification failed');
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
      }
    }

    async function login() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!username || !password) {
        return showAlert('Please fill all fields');
      }

      const formData = new FormData();
      formData.append('action', 'login');
      formData.append('username', username);
      formData.append('password', password);

      try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const data = await response.json();

        if (data.status === 'success') {
          currentUser = data.user;
          showDashboard();
          showAlert('Login successful! Welcome back.');
        } else {
          showAlert(data.message || 'Login failed');
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
      }
    }

    function showDashboard() {
      document.getElementById('authScreens').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('chatToggle').style.display = 'block';

      document.getElementById('displayUsername').textContent = currentUser.username;
      document.getElementById('userAvatar').textContent = currentUser.username[0].toUpperCase();
      document.getElementById('balanceValue').textContent = Number(currentUser.balance).toLocaleString();
      document.getElementById('usdBalanceValue').textContent = '$' + Number(currentUser.balanceUSD).toFixed(4);

      showPage('work');
    }

    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    function openOfferwallInIframe(offerwallId, url) {
      const iframe = document.getElementById('offerwallFrame');
      const iframeContainer = document.getElementById('iframeContainer');
      const offerwallList = document.getElementById('offerwallList');
      
      iframe.src = url;
      iframeContainer.style.display = 'block';
      offerwallList.style.display = 'none';
    }

    function closeIframe() {
      const iframeContainer = document.getElementById('iframeContainer');
      const offerwallList = document.getElementById('offerwallList');
      const iframe = document.getElementById('offerwallFrame');
      
      iframeContainer.style.display = 'none';
      offerwallList.style.display = 'block';
      iframe.src = 'about:blank';
    }

    async function submitWork() {
      if (!currentUser) return;

      const text = document.getElementById('workInput').value.trim();
      if (!text) return showAlert('Please write something');

      const formData = new FormData();
      formData.append('action', 'submitWork');
      formData.append('username', currentUser.username);
      formData.append('submission', text);

      try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const data = await response.json();
        showAlert(data.message);
        document.getElementById('workInput').value = '';
      } catch (error) {
        showAlert('Network error. Please try again.');
      }
    }

    function toggleChat() {
      const chatBox = document.getElementById('chatBox');
      
      if (chatBox.style.display === 'none') {
        chatBox.style.display = 'block';
      } else {
        chatBox.style.display = 'none';
      }
    }

    function handleChatInput(event) {
      if (event.key === 'Enter') {
        sendChatMessage();
      }
    }

    async function sendChatMessage() {
      if (!currentUser) return;

      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const formData = new FormData();
      formData.append('action', 'sendChatMessage');
      formData.append('username', currentUser.username);
      formData.append('message', message);

      try {
        await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        input.value = '';
      } catch (error) {
        showAlert('Failed to send message');
      }
    }

    function logout() {
      if (chatInterval) clearInterval(chatInterval);
      location.reload();
    }

    function showAlert(msg) {
      document.getElementById('alertMessage').textContent = msg;
      document.getElementById('alertModal').style.display = 'block';
    }

    function closeAlert() {
      document.getElementById('alertModal').style.display = 'none';
    }

    document.getElementById('rewardSelect').onchange = function() {
      document.getElementById('cashoutBtn').disabled = !this.value;
    };

    window.onload = init;
  </script>

  <style>
    .hidden { display: none !important; }
    #loadingScreen { text-align: center; padding: 40px; }
    #authScreens { display: block; }
    #dashboard { display: none; }
    #chatToggle { display: none; position: fixed; bottom: 30px; right: 30px; }
    #chatBox { display: none; position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px; }
    #alertModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); }
    .auth-card { display: none; }
    .page { display: none; }
    .iframe-container { display: none; }
  </style>
</body>
</html>
